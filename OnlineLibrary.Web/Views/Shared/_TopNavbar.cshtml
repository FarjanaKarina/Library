@using OnlineLibrary.Infrastructure.Data
@inject ApplicationDbContext Db

@{
    var role = ViewBag.CurrentRole as string;
}
@{
    var userIdStr = Context.Session.GetString("UserId");
    var roleIdStr = Context.Session.GetString("RoleId");

    string? roleName = null;

    if (!string.IsNullOrEmpty(roleIdStr))
    {
        var roleId = Guid.Parse(roleIdStr);
        roleName = Db.Roles
            .Where(r => r.RoleId == roleId)
            .Select(r => r.RoleName)
            .FirstOrDefault();
    }

    bool isLoggedIn = !string.IsNullOrEmpty(userIdStr);
    bool isAdmin = roleName == "Admin";
    bool isLibrarian = roleName == "Librarian";
    bool isStudent = roleName == "Student";
}

<nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm fixed-top">
    <div class="container-fluid px-4">

        <!-- LOGO -->
        <a class="navbar-brand fw-bold fs-4 d-flex align-items-center"
           asp-controller="Home"
           asp-action="Index">
            <img src="~/images/BookNestLogo.png" style="width:32px" class="me-2" />
            <span class="text-danger">Book</span>Nest
        </a>

        <!-- TOGGLER -->
        <button class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#mainNavbar">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- NAV CONTENT -->
        <div class="collapse navbar-collapse" id="mainNavbar">

            <!-- CENTER MENU (PUBLIC PAGES) -->
            @if (!isLoggedIn)
            {
                <ul class="navbar-nav mx-auto gap-4 fw-semibold">
                    <li class="nav-item">
                        <a class="nav-link" asp-controller="Home" asp-action="Index">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-controller="Home" asp-action="About">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-controller="Book" asp-action="Browse">Books</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-controller="Home" asp-action="Contact">Contact</a>
                    </li>
                </ul>
            }


            <!-- RIGHT ICONS -->
            <ul class="navbar-nav ms-auto align-items-center gap-2 navbar-icons">

                <!-- 🔍 SEARCH (ONLY GUEST + STUDENT) -->
                @if (isStudent)
                {
                    <!-- Student → modal search -->
                    <li class="nav-item">
                        <button type="button"
                                class="btn nav-link p-0"
                                data-bs-toggle="modal"
                                data-bs-target="#studentSearchModal">
                            <i class="bi bi-search fs-4"></i>
                        </button>
                    </li>
                }
                else if (!isAdmin && !isLibrarian)
                {
                    <!-- Guest → landing page scroll search -->
                    <li class="nav-item @(isStudent ? "" : "d-none")" id="navSearchIcon">
                        <button type="button"
                                class="btn nav-link p-0"
                                id="navSearchBtn"
                                aria-label="Search">
                            <i class="bi bi-search fs-4"></i>
                        </button>

                    </li>
                }

                <!-- 🔔 NOTIFICATIONS (LOGGED IN USERS ONLY) -->
                @if (isLoggedIn)
                {
                    var uid = Guid.Parse(userIdStr);
                    var unread = Db.Notifications.Count(n => n.UserId == uid && !n.IsRead);

                    <li class="nav-item notification-wrapper">
                        <a class="nav-link notification-link"
                           asp-controller="Notification"
                           asp-action="Index"
                           id="notificationLink"
                           title="Notifications">
                            <i class="bi bi-bell fs-4"></i>

                            @if (unread > 0)
                            {
                                <span class="notification-badge" id="notificationBadge">@unread</span>
                            }
                        </a>
                    </li>
                }

                <!-- 👤 ACCOUNT -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle"
                       href="#"
                       role="button"
                       data-bs-toggle="dropdown">
                        <i class="bi bi-person fs-4"></i>
                    </a>

                    <ul class="dropdown-menu dropdown-menu-end">

                        @if (!isLoggedIn)
                        {
                            <li>
                                <a class="dropdown-item"
                                   href="#"
                                   onclick="openLoginModal()">
                                    Sign In
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item"
                                   href="#"
                                   onclick="openRegisterModal()">
                                    Sign Up
                                </a>
                            </li>
                        }
                        else
                        {
                            <li>
                                <form asp-controller="Account"
                                      asp-action="Logout"
                                      method="post">
                                    <button type="submit"
                                            class="dropdown-item text-danger d-flex align-items-center gap-2">
                                        <i class="bi bi-box-arrow-right"></i>
                                        Logout
                                    </button>
                                </form>
                            </li>
                        }

                    </ul>
                </li>

                <!-- ❤️ WISHLIST (ONLY GUEST + STUDENT) -->
                @if (!isAdmin && !isLibrarian)
                {
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="bi bi-heart fs-4"></i>
                        </a>
                    </li>
                }

                <!-- 🌙 DARK MODE (ALL USERS) -->
                <li class="nav-item">
                    <button class="btn nav-link p-0" onclick="toggleDarkMode()">
                        <i class="bi bi-moon fs-4"></i>
                    </button>
                </li>

            </ul>
        </div>
    </div>
</nav>
