@model IEnumerable<OnlineLibrary.Web.Models.PublicBookViewModel>

@{
    ViewData["Title"] = "Online Library";
}
<body class="page-landing">
    @if (ViewBag.CurrentRole != "Admin" && ViewBag.CurrentRole != "Librarian")
    {
        <!-- =========================
             SEARCH BAR (AJAX)
        ========================= -->
        <section class="hero-section">

            <!-- SEARCH BAR -->
            <div class="hero-search" id="topSearch">
                <div class="search-box">
                    <input type="text"
                           id="searchInput"
                           placeholder="Search by title, author, publisher or category" />
                    <button type="button">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>

            <!-- FEATURED CAROUSEL -->
            <div id="featuredCarousel"
                 class="carousel slide hero-carousel"
                 data-bs-ride="carousel">

                <div class="carousel-inner">

                    @{
                        var books = ViewBag.FeaturedBooks as List<FeaturedBookViewModel>
                        ?? new List<FeaturedBookViewModel>();
                        var isFirst = true;
                    }

                    @foreach (var book in books)
                    {
                        <div class="carousel-item @(isFirst ? "active" : "")">
                            @{
                                isFirst = false;
                            }

                            <div class="row align-items-center">

                                <!-- LEFT CONTENT -->
                                <div class="col-md-6 px-5">

                                    <span class="hero-badge">New Release</span>

                                    <h1 class="hero-title">
                                        @book.Title
                                    </h1>

                                    <p class="hero-text mt-3">
                                        @book.Description
                                    </p>

                                    <div class="mt-4 d-flex gap-3 flex-wrap">

                                        <!-- VIEW DETAILS -->
                                        <a asp-controller="Book"
                                           asp-action="Details"
                                           asp-route-id="@book.BookId"
                                           class="hero-btn">
                                            View Details
                                        </a>

                                        <!-- READ ONLINE -->
                                        @if (!string.IsNullOrEmpty(book.PdfUrl))
                                        {
                                            @if (Context.Session.GetString("UserId") == null)
                                            {
                                                <a asp-controller="Account"
                                                   asp-action="Login"
                                                   class="hero-btn-outline">
                                                    Read Online
                                                </a>
                                            }
                                            else
                                            {
                                                <a asp-controller="Book"
                                                   asp-action="Details"
                                                   asp-route-id="@book.BookId"
                                                   class="hero-btn-outline">
                                                    Read Online
                                                </a>
                                            }
                                        }
                                    </div>
                                </div>

                                <!-- RIGHT IMAGE -->
                                <div class="col-md-6 text-center">
                                    <img src="@book.ImageUrl"
                                         class="hero-book-img"
                                         alt="@book.Title" />
                                </div>

                            </div>
                        </div>
                    }
                </div>

                <!-- ARROWS -->
                <button class="carousel-control-prev"
                        type="button"
                        data-bs-target="#featuredCarousel"
                        data-bs-slide="prev">
                    <span class="hero-arrow">&#10094;</span>
                </button>

                <button class="carousel-control-next"
                        type="button"
                        data-bs-target="#featuredCarousel"
                        data-bs-slide="next">
                    <span class="hero-arrow">&#10095;</span>
                </button>
            </div>

        </section>


        <!-- =========================
             INITIAL BOOK CAROUSEL
        ========================= -->
        <div class="container mt-4" id="defaultBooks">

            @if (Model == null || !Model.Any())
            {
                <div class="alert alert-warning text-center">
                    No books available.
                </div>
            }
            else
            {
                <div class="d-flex overflow-auto gap-3 pb-3">

                    @foreach (var book in Model)
                    {
                        <div class="card shadow-sm" style="min-width:220px;">

                            <img src="@book.ImageUrl"
                                 class="card-img-top"
                                 style="height:280px; object-fit:cover;" />

                            <div class="card-body">
                                <h6 class="card-title">@book.Title</h6>
                                <p class="mb-1 text-muted">@book.Author</p>

                                <!-- MULTIPLE CATEGORIES -->
                                <div class="mb-2">
                                    @if (book.Categories != null && book.Categories.Any())
                                    {
                                        foreach (var cat in book.Categories)
                                        {
                                            <span class="badge bg-secondary me-1">
                                                @cat
                                            </span>
                                        }
                                    }
                                </div>

                                <a asp-controller="Book"
                                   asp-action="Details"
                                   asp-route-id="@book.BookId"
                                   class="btn btn-sm btn-secondary w-100">
                                    View Details
                                </a>
                            </div>
                        </div>
                    }

                </div>
            }
        </div>


        <!-- =========================
             SCRIPTS (AJAX LIVE SEARCH)
        ========================= -->
        @section Scripts {
            <script>
                let timer = null;

                function loadSearch() {
                    clearTimeout(timer);

                    timer = setTimeout(function () {

                        const search = $("#searchInput").val();

                        if (search.trim().length === 0) {
                            $("#searchResults").empty();
                            $("#defaultBooks").show();
                            return;
                        }

                        $("#defaultBooks").hide();

                        $.get("/Home/Search", { search: search }, function (data) {

                            let html = "";

                            if (data.length === 0) {
                                html = `
                                    <div class="col-12">
                                        <div class="alert alert-warning text-center">
                                            No books found.
                                        </div>
                                    </div>`;
                            } else {
                                data.forEach(b => {
                                    html += `
                                    <div class="col-md-3 mb-4">
                                        <div class="card shadow-sm h-100">
                                            <img src="${b.imageUrl}"
                                                 class="card-img-top"
                                                 style="height:220px;object-fit:cover;">
                                            <div class="card-body">
                                                <h6>${b.title}</h6>
                                                <p class="text-muted">${b.author}</p>
                                                <a href="/Book/Details/${b.bookId}"
                                                   class="btn btn-sm btn-secondary w-100">
                                                    View Details
                                                </a>
                                            </div>
                                        </div>
                                    </div>`;
                                });
                            }

                            $("#searchResults").html(html);
                        });

                    }, 400);
                }

                $("#searchInput").on("keyup", loadSearch);

                             document.addEventListener("DOMContentLoaded", function () {

                    const searchBtn = document.getElementById("navSearchBtn");
                    const searchInput = document.getElementById("searchInput");
                    const searchSection = document.getElementById("topSearch");

                    if (!searchBtn || !searchInput || !searchSection) return;

                    searchBtn.addEventListener("click", function () {
                        // Scroll to search bar
                        searchSection.scrollIntoView({
                            behavior: "smooth",
                            block: "center"
                        });

                        // Focus input after scroll
                        setTimeout(() => {
                            searchInput.focus();
                        }, 500);
                    });

                });
            </script>
        }
    }
</body>