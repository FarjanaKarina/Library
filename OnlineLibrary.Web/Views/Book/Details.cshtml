@model OnlineLibrary.Web.Models.BookDetailsViewModel

@{
    // Dynamic layout selection logic
    string layout = "_AppLayout";
    if (ViewBag.CurrentRole == "Student") { layout = "_StudentLayout"; }
    else if (ViewBag.CurrentRole == "Admin") { layout = "_AdminLayout"; }
    else if (ViewBag.CurrentRole == "Librarian") { layout = "_LibrarianLayout"; }
    Layout = layout;

    ViewData["Title"] = Model.Title;
}

<div class="container my-5">
    <div class="row">
        <!-- Left Column: Book Cover and Actions -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4 sticky-top" style="top: 20px;">
                <img src="@(string.IsNullOrEmpty(Model.ImageUrl) ? "/images/default-book.png" : Model.ImageUrl)"
                     class="card-img-top" alt="@Model.Title" style="height: 450px; object-fit: contain;">
                <div class="card-body text-center">
                    <h4 class="card-title text-primary fw-bold">৳@Model.Price.ToString("N0")</h4>
                    <div class="d-grid gap-2 mt-3">
                        <!-- === MODIFIED: Corrected logic for all roles === -->
                        @if (ViewBag.CurrentRole == "Student")
                        {
                            <div class="d-flex gap-2 mb-2">
                                <button class="btn btn-success btn-lg flex-grow-1" onclick="addToCart('@Model.BookId')">
                                    <i class="bi bi-cart-plus me-2"></i>Add to Cart
                                </button>
                                <button class="btn btn-outline-danger btn-lg px-3" onclick="toggleWishlist('@Model.BookId', this)">
                                    <i class="bi bi-heart" id="wishlistIcon"></i>
                                </button>
                            </div>
                        }
                        else if (ViewBag.IsLoggedIn != true)
                        {
                            // For guest users, the button now opens the login modal
                            <button class="btn btn-success btn-lg w-100" onclick="openLoginModal('@Context.Request.Path')">
                                <i class="bi bi-cart-plus me-2"></i>Add to Cart
                            </button>
                        }
                        
                        @if (!string.IsNullOrEmpty(Model.PdfUrl))
                        {
                            // TYPO FIX: Corrected "CurentRole" to "CurrentRole"
                            if (ViewBag.CurrentRole == "Student" || ViewBag.CurrentRole == "Admin" || ViewBag.CurrentRole == "Librarian")
                            {
                                // "Read Sample" button for all logged-in roles
                                <button class="btn btn-outline-secondary w-100" data-bs-toggle="modal" data-bs-target="#pdfReaderModal">
                                    <i class="bi bi-book me-2"></i>Read Sample
                                </button>
                            }
                            else
                            {
                                // "Read Sample" button for guests opens the login modal
                                <button class="btn btn-outline-secondary w-100" onclick="openLoginModal('@Context.Request.Path')">
                                    <i class="bi bi-book me-2"></i>Read Sample
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Book Information -->
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="display-5 fw-bold">@Model.Title</h1>
                    <p class="text-muted fs-5 mb-2">by @Model.Author</p>
                    <div>
                        @foreach (var cat in Model.Categories)
                        {
                            <span class="badge bg-info text-dark me-1">@cat</span>
                        }
                    </div>
                </div>
               
            </div>
            <hr>
            <div class="mb-4">
                <h5 class="mb-3">Description</h5>
                <p style="text-align: justify;">@Model.Description</p>
            </div>
            <div class="card bg-light border-0">
                <div class="card-body">
                    <h5 class="mb-4">Book Details</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3"><strong>Publisher</strong><br><span>@Model.Publisher</span></div>
                        <div class="col-md-6 mb-3"><strong>Publish Date</strong><br><span>@Model.PublishDate.ToString("dd MMMM yyyy")</span></div>
                        <div class="col-md-6 mb-3"><strong>ISBN</strong><br><span>@Model.ISBN</span></div>
                        <div class="col-md-6 mb-3"><strong>Available Copies</strong><br><span class="badge bg-success">@Model.TotalCopies</span></div>
                    </div>
                </div>
            </div>
            <!-- === MODIFIED: Dynamic Back button for all roles === -->
            <div class="mt-4 d-flex justify-content-end">
                <button class="btn btn-secondary" onclick="window.history.length > 1 ? history.back() : window.location.href='@Url.Action("Index", "Home")'">
                    <i class="bi bi-arrow-left"></i> @(ViewBag.CurrentRole == "Admin" || ViewBag.CurrentRole == "Librarian" ? "Back to Previous" : "Back")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PDF Reader Modal -->
@if (!string.IsNullOrEmpty(Model.PdfUrl))
{
    <div class="modal fade" id="pdfReaderModal" tabindex="-1" aria-labelledby="pdfReaderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="pdfReaderModalLabel">Sample: @Model.Title</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body p-0" style="height: 80vh;">
                    <div class="pdf-watermark">BookNest • For Reading Only</div>
                    <div id="pdf-viewer" class="overflow-auto h-100 bg-secondary-subtle text-center p-4"></div>
                </div>
                <div class="modal-footer justify-content-center"><p class="text-muted mb-0">Showing first 30 pages as a sample.</p></div>
            </div>
        </div>
    </div>
}

@section Scripts {
<script>
    function addToCart(bookId) {
        $.ajax({
            url: '/Cart/Add', type: 'POST', data: { bookId: bookId },
            success: function (response) {
                if (response.success) {
                    Swal.fire({ title: 'Success!', text: response.message, icon: 'success', showConfirmButton: false, timer: 1500 });
                    if (response.cartCount) { $('.cart-count').text(response.cartCount); }
                } else { Swal.fire({ title: 'Error', text: response.message, icon: 'error' }); }
            },
            error: function () { Swal.fire({ title: 'Error', text: 'An unexpected error occurred.', icon: 'error' }); }
        });
    }

    function toggleWishlist(bookId, button) {
        fetch('/Wishlist/Toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bookId)
        })
        .then(res => res.json())
        .then(data => {
            const icon = document.getElementById('wishlistIcon');
            if (icon) {
                icon.classList.toggle('bi-heart-fill', data.added);
                icon.classList.toggle('bi-heart', !data.added);
            }
        });
    }

    // Initialize wishlist icon state
    document.addEventListener('DOMContentLoaded', function() {
        if ('@ViewBag.CurrentRole' === 'Student') {
            fetch('/Wishlist/GetUserWishlistIds')
                .then(res => res.json())
                .then(ids => {
                    const icon = document.getElementById('wishlistIcon');
                    if (icon && ids.includes('@Model.BookId')) {
                        icon.classList.remove('bi-heart');
                        icon.classList.add('bi-heart-fill');
                    }
                });
        }
    });

    // PDF rendering and security scripts
    document.addEventListener('DOMContentLoaded', function () {
        const pdfModal = document.getElementById('pdfReaderModal');
        if (pdfModal) {
            const pdfUrl = '/Book/ReadPdf/@Model.BookId';
            const viewerContainer = document.getElementById('pdf-viewer');
            const maxPages = 30;

            async function renderPdf() {
                // === ADDED: Logic to update student reading history ===
                if ('@ViewBag.CurrentRole' === 'Student') {
                    fetch('/Book/UpdateReadingHistory', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `bookId=@Model.BookId`
                    }).catch(err => console.error('Could not update reading history:', err));
                }

                viewerContainer.innerHTML = `<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border" role="status"></div><span class="ms-3">Loading Sample...</span></div>`;
                
                try {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
                    const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
                    viewerContainer.innerHTML = '';

                    const totalPagesToRender = Math.min(pdf.numPages, maxPages);

                    for (let pageNum = 1; pageNum <= totalPagesToRender; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const scale = 1.5;
                        const viewport = page.getViewport({ scale: scale });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        canvas.classList.add('d-block', 'mx-auto', 'mb-3', 'shadow-sm');
                        
                        viewerContainer.appendChild(canvas);

                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                    }
                } catch (reason) {
                    console.error(reason);
                    viewerContainer.innerHTML = '<div class="alert alert-danger m-3">Error: Could not load the PDF sample. Please ensure you are logged in and have permission.</div>';
                }
            }

            pdfModal.addEventListener('shown.bs.modal', renderPdf);
        }
    });

    // Security scripts
    document.addEventListener("contextmenu", function (e) { if (document.getElementById("pdfReaderModal")?.classList.contains("show")) e.preventDefault(); });
    document.addEventListener("keydown", function (e) { if (document.getElementById("pdfReaderModal")?.classList.contains("show") && e.ctrlKey && (e.key === 'p' || e.key === 's')) e.preventDefault(); });
</script>
}