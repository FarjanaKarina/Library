@model IEnumerable<OnlineLibrary.Web.Models.StudentBookViewModel>

@{
    Layout = "_StudentLayout";
}

@{
    ViewData["Title"] = "Browse Books";
}

<div class="container mt-4">
    <div class="hero-search mb-4">
        <div class="search-box">
            <input type="text"
                   id="searchInput"
                   placeholder="Search by title, author, publisher or category" />
            <button type="button">
                <i class="bi bi-search"></i>
            </button>
        </div>
    </div>

    <div class="row" id="searchResults"></div>
    <div class="row" id="defaultBooks">
        <!-- your book cards -->
        <div class="row">
            @foreach (var book in Model)
            {
                <div class="col-md-3 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="position-relative">
                            <!-- BOOK IMAGE -->
                            <img src="@book.ImageUrl"
                                 class="card-img-top"
                                 style="height:230px; object-fit:cover;"
                                 onerror="this.src='/images/no-book.png'" />

                            <!-- ❤️ WISHLIST -->
                            <button class="wishlist-btn"
                                    onclick="toggleWishlist('@book.BookId', this)">
                                <i class="bi bi-heart"></i>
                            </button>

                        </div>

                        <div class="card-body d-flex flex-column">

                            <!-- TITLE -->
                            <h6 class="fw-semibold mb-1">
                                @book.Title
                            </h6>

                            <!-- AUTHOR -->
                            <small class="text-muted mb-2">
                                @book.Author
                            </small>

                            <!-- PRICE + AVAILABILITY -->
                            <div class="mb-3 small">

                                <div>
                                    <strong>Price:</strong>
                                    <span class="text-dark">
                                        @book.Price.ToString("0.00") TK
                                    </span>
                                </div>

                                <div>
                                    <strong>Status:</strong>
                                    @if (book.AvailableCopies > 0)
                                    {
                                        <span class="text-success">Available</span>
                                    }
                                    else
                                    {
                                        <span class="text-danger">Not Available</span>
                                    }
                                </div>

                            </div>

                            <!-- VIEW DETAILS -->
                            <a asp-controller="Book"
                               asp-action="Details"
                               asp-route-id="@book.BookId"
                               class="btn btn-sm btn-outline-primary mt-auto">
                                View Details
                            </a>

                        </div>
                    </div>
                </div>
            }
        </div>

        }
    </div>
</div>
@section Scripts {
    <script>
        let timer = null;

        function loadSearch() {
            clearTimeout(timer);

            timer = setTimeout(function () {

                const search = $("#searchInput").val();

                if (search.trim().length === 0) {
                    $("#searchResults").empty();
                    $("#defaultBooks").show();
                    return;
                }

                $("#defaultBooks").hide();

                $.get("/Home/Search", { search: search }, function (data) {

                    let html = "";

                    if (data.length === 0) {
                        html = `
                            <div class="col-12">
                                <div class="alert alert-warning text-center">
                                    No books found.
                                </div>
                            </div>`;
                    } else {
                        data.forEach(b => {
                            html += `
                            <div class="col-md-3 mb-4">
                                <div class="card shadow-sm h-100">
                                    <img src="${b.imageUrl}"
                                         class="card-img-top"
                                         style="height:220px;object-fit:cover;">
                                    <div class="card-body">
                                        <h6>${b.title}</h6>
                                        <p class="text-muted">${b.author}</p>
                                        <a href="/Book/Details/${b.bookId}"
                                           class="btn btn-sm btn-secondary w-100">
                                            View Details
                                        </a>
                                    </div>
                                </div>
                            </div>`;
                        });
                    }

                    $("#searchResults").html(html);
                });

            }, 400);
        }

        $("#searchInput").on("keyup", loadSearch);

                     document.addEventListener("DOMContentLoaded", function () {

            const searchBtn = document.getElementById("navSearchBtn");
            const searchInput = document.getElementById("searchInput");
            const searchSection = document.getElementById("topSearch");

            if (!searchBtn || !searchInput || !searchSection) return;

            searchBtn.addEventListener("click", function () {
                // Scroll to search bar
                searchSection.scrollIntoView({
                    behavior: "smooth",
                    block: "center"
                });

                // Focus input after scroll
                setTimeout(() => {
                    searchInput.focus();
                }, 500);
            });

        });
          // ❤️ WISHLIST TOGGLE FUNCTION
        function toggleWishlist(bookId, button) {
            fetch('/Wishlist/Toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bookId)
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Please log in to add books to your wishlist');
                        return;
                    }
                    throw new Error('Failed to toggle wishlist');
                }
                return response.json();
            })
            .then(data => {
                const icon = button.querySelector('i');
                if (data.added) {
                    icon.classList.remove('bi-heart');
                    icon.classList.add('bi-heart-fill');
                    button.style.background = 'rgba(220, 53, 69, 0.9)';
                } else {
                    icon.classList.remove('bi-heart-fill');
                    icon.classList.add('bi-heart');
                    button.style.background = 'rgba(255, 255, 255, 0.9)';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update wishlist');
            });
        }
    </script>

}